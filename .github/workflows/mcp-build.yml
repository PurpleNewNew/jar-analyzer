name: mcp-build

on:
  workflow_dispatch:

jobs:

  mcp-build:

    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:

      - name: set version
        run: |
          echo "MCP_VERSION=v1.2.1" >> $GITHUB_ENV
          echo "REPORT_VERSION=v1.2.1" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: set up go
        uses: actions/setup-go@v6
        with:
          go-version: '1.24.10'

      - name: build gox
        run: |
          set -x
          cd gox
          go build -o ../my-gox

      - name: build jar-analyzer mcp lines
        run: |
          set -euxo pipefail
          MCP_OUT="${GITHUB_WORKSPACE}/mcp-build"
          mkdir -p "$MCP_OUT"
          GOX="${GITHUB_WORKSPACE}/my-gox"
          OSARCH="darwin/arm64 darwin/amd64 linux/386 linux/amd64 linux/arm linux/arm64 windows/386 windows/amd64"
          LDFLAGS="-extldflags=-static -s -w"

          build_line() {
            local dir="$1"
            local bin="$2"
            (cd "mcp/cmd/${dir}" && "$GOX" -parallel 5 -osarch="$OSARCH" -ldflags="$LDFLAGS" -output="${MCP_OUT}/${bin}_${MCP_VERSION}_{{.OS}}_{{.Arch}}")
          }

          build_line audit_fast mcp-audit-fast
          build_line graph_lite mcp-graph-lite
          build_line dfs_taint mcp-dfs
          build_line sca_leak mcp-sca-leak
          build_line vul_rules mcp-vul-rules

      - name: build jar-analyzer-report-mcp
        run: |
          set -euxo pipefail
          REPORT_OUT="${GITHUB_WORKSPACE}/report-mcp-build"
          mkdir -p "$REPORT_OUT"
          GOX="${GITHUB_WORKSPACE}/my-gox"
          OSARCH="darwin/arm64 darwin/amd64 linux/386 linux/amd64 linux/arm linux/arm64 windows/386 windows/amd64"
          LDFLAGS="-extldflags=-static -s -w"
          (cd mcp/cmd/service_report && "$GOX" -parallel 5 -osarch="$OSARCH" -ldflags="$LDFLAGS" -output="${REPORT_OUT}/report_mcp_${REPORT_VERSION}_{{.OS}}_{{.Arch}}")

      - name: create build file
        run: |
          set -euxo pipefail
          sudo apt-get install -y zip unzip
          cd "$GITHUB_WORKSPACE"
          zip -j mcp-build.zip mcp-build/*
          zip -j report-mcp-build.zip report-mcp-build/*

      - name: upload core
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-core
          path: mcp-build.zip

      - name: upload report
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-report
          path: report-mcp-build.zip
