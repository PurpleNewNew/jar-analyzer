<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ GPLv3 License
  ~
  ~ Copyright (c) 2022-2026 4ra1n (Jar Analyzer Team)
  ~
  ~ This project is distributed under the GPLv3 license.
  ~
  ~ https://github.com/jar-analyzer/jar-analyzer/blob/master/LICENSE
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.n1ar4.jar.analyzer.core.mapper.MethodCallMapper">
    <resultMap id="methodMap" type="me.n1ar4.jar.analyzer.entity.MethodResult">
        <result column="method_id" property="methodId"/>
        <result column="method_name" property="methodName"/>
        <result column="class_name" property="className"/>
        <result column="method_desc" property="methodDesc"/>
        <result column="jar_name" property="jarName"/>
        <result column="jar_id" property="jarId"/>
    </resultMap>
    <resultMap id="callEdgeMap" type="me.n1ar4.jar.analyzer.entity.MethodCallResult">
        <result column="caller_class_name" property="callerClassName"/>
        <result column="caller_method_name" property="callerMethodName"/>
        <result column="caller_method_desc" property="callerMethodDesc"/>
        <result column="caller_jar_id" property="callerJarId"/>
        <result column="caller_jar_name" property="callerJarName"/>
        <result column="callee_class_name" property="calleeClassName"/>
        <result column="callee_method_name" property="calleeMethodName"/>
        <result column="callee_method_desc" property="calleeMethodDesc"/>
        <result column="callee_jar_id" property="calleeJarId"/>
        <result column="callee_jar_name" property="calleeJarName"/>
        <result column="op_code" property="opCode"/>
        <result column="edge_type" property="edgeType"/>
        <result column="edge_confidence" property="edgeConfidence"/>
        <result column="edge_evidence" property="edgeEvidence"/>
    </resultMap>
    <insert id="insertMethodCall" parameterType="MethodCallEntity">
        INSERT OR IGNORE INTO method_call_table
        (
        caller_mid, callee_mid, op_code, edge_type, edge_confidence, edge_evidence
        )
        VALUES
        <foreach collection="list" separator="," item="item">
            (
            #{item.callerMid}, #{item.calleeMid}, #{item.opCode},
            #{item.edgeType}, #{item.edgeConfidence}, #{item.edgeEvidence}
            )
        </foreach>
    </insert>
    <select id="selectCallers" resultMap="methodMap">
        SELECT DISTINCT
        caller.method_id AS method_id,
        caller.method_name AS method_name,
        caller.class_name AS class_name,
        caller.method_desc AS method_desc,
        jt.jar_name AS jar_name,
        caller.jar_id AS jar_id
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt ON caller.jar_id = jt.jid
        <where>
            <if test="calleeClassName != null and calleeClassName != ''">
                AND callee.class_name = #{calleeClassName}
            </if>
            <if test="calleeMethodName != null and calleeMethodName != ''">
                AND callee.method_name = #{calleeMethodName}
            </if>
            <if test="calleeMethodDesc != null and calleeMethodDesc != ''">
                AND callee.method_desc = #{calleeMethodDesc}
            </if>
        </where>
    </select>
    <select id="selectCalleeMethodIdsByConditions" resultType="java.lang.Integer">
        SELECT DISTINCT
        method_id
        FROM method_table
        <where>
            <foreach collection="list" item="item" separator=" OR ">
                (
                class_name = #{item.calleeClassName}
                AND method_name = #{item.calleeMethodName}
                <if test="item.calleeMethodDesc != null and item.calleeMethodDesc != ''">
                    AND method_desc = #{item.calleeMethodDesc}
                </if>
                )
            </foreach>
        </where>
    </select>
    <select id="selectCallersByCalleeMids" resultMap="methodMap">
        SELECT DISTINCT
        caller.method_id AS method_id,
        caller.method_name AS method_name,
        caller.class_name AS class_name,
        caller.method_desc AS method_desc,
        jt.jar_name AS jar_name,
        caller.jar_id AS jar_id
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        LEFT JOIN jar_table jt ON caller.jar_id = jt.jid
        WHERE mc.callee_mid IN
        <foreach collection="list" item="item" open="(" close=")" separator=",">
            #{item}
        </foreach>
    </select>
    <select id="selectCallersLike" resultMap="methodMap">
        SELECT DISTINCT
        caller.method_id AS method_id,
        caller.method_name AS method_name,
        caller.class_name AS class_name,
        caller.method_desc AS method_desc,
        jt.jar_name AS jar_name,
        caller.jar_id AS jar_id
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt ON caller.jar_id = jt.jid
        <where>
            <if test="calleeClassName != null and calleeClassName != ''">
                AND callee.class_name LIKE CONCAT('%', #{calleeClassName}, '%')
            </if>
            <if test="calleeMethodName != null and calleeMethodName != ''">
                AND callee.method_name LIKE CONCAT('%', #{calleeMethodName}, '%')
            </if>
            <if test="calleeMethodDesc != null and calleeMethodDesc != ''">
                AND callee.method_desc = #{calleeMethodDesc}
            </if>
        </where>
    </select>
    <select id="selectCallee" resultMap="methodMap">
        SELECT DISTINCT
        callee.method_id AS method_id,
        callee.method_name AS method_name,
        callee.class_name AS class_name,
        callee.method_desc AS method_desc,
        jt.jar_name AS jar_name,
        callee.jar_id AS jar_id
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt ON callee.jar_id = jt.jid
        <where>
            <if test="callerClassName != null and callerClassName != ''">
                AND caller.class_name = #{callerClassName}
            </if>
            <if test="callerMethodName != null and callerMethodName != ''">
                AND caller.method_name = #{callerMethodName}
            </if>
            <if test="callerMethodDesc != null and callerMethodDesc != ''">
                AND caller.method_desc = #{callerMethodDesc}
            </if>
        </where>
    </select>
    <select id="selectEdgeMeta" resultType="me.n1ar4.jar.analyzer.entity.MethodCallEntity">
        SELECT
        mc.edge_type AS edgeType,
        mc.edge_confidence AS edgeConfidence,
        mc.edge_evidence AS edgeEvidence
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        <where>
            caller.class_name = #{callerClassName}
            AND caller.method_name = #{callerMethodName}
            AND caller.method_desc = #{callerMethodDesc}
            AND callee.class_name = #{calleeClassName}
            AND callee.method_name = #{calleeMethodName}
            AND callee.method_desc = #{calleeMethodDesc}
        </where>
        LIMIT 1
    </select>
    <select id="selectEdgeMetaBatch" resultType="me.n1ar4.jar.analyzer.entity.MethodCallEntity">
        SELECT
        caller.class_name AS callerClassName,
        caller.method_name AS callerMethodName,
        caller.method_desc AS callerMethodDesc,
        callee.class_name AS calleeClassName,
        callee.method_name AS calleeMethodName,
        callee.method_desc AS calleeMethodDesc,
        mc.edge_type AS edgeType,
        mc.edge_confidence AS edgeConfidence,
        mc.edge_evidence AS edgeEvidence
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        <where>
            <foreach collection="list" item="item" separator=" OR ">
                (
                caller.class_name = #{item.callerClassName}
                AND caller.method_name = #{item.callerMethodName}
                AND caller.method_desc = #{item.callerMethodDesc}
                AND callee.class_name = #{item.calleeClassName}
                AND callee.method_name = #{item.calleeMethodName}
                AND callee.method_desc = #{item.calleeMethodDesc}
                )
            </foreach>
        </where>
    </select>
    <select id="selectCallEdgesByCallee" resultMap="callEdgeMap">
        SELECT
        caller.class_name AS caller_class_name,
        caller.method_name AS caller_method_name,
        caller.method_desc AS caller_method_desc,
        caller.jar_id AS caller_jar_id,
        jt1.jar_name AS caller_jar_name,
        callee.class_name AS callee_class_name,
        callee.method_name AS callee_method_name,
        callee.method_desc AS callee_method_desc,
        callee.jar_id AS callee_jar_id,
        jt2.jar_name AS callee_jar_name,
        mc.op_code AS op_code,
        mc.edge_type AS edge_type,
        mc.edge_confidence AS edge_confidence,
        mc.edge_evidence AS edge_evidence
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt1 ON caller.jar_id = jt1.jid
        LEFT JOIN jar_table jt2 ON callee.jar_id = jt2.jid
        <where>
            <if test="calleeClassName != null and calleeClassName != ''">
                AND callee.class_name = #{calleeClassName}
            </if>
            <if test="calleeMethodName != null and calleeMethodName != ''">
                AND callee.method_name = #{calleeMethodName}
            </if>
            <if test="calleeMethodDesc != null and calleeMethodDesc != ''">
                AND callee.method_desc = #{calleeMethodDesc}
            </if>
        </where>
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
            <if test="offset != null and offset &gt;= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>
    <select id="selectCallEdgesByCaller" resultMap="callEdgeMap">
        SELECT
        caller.class_name AS caller_class_name,
        caller.method_name AS caller_method_name,
        caller.method_desc AS caller_method_desc,
        caller.jar_id AS caller_jar_id,
        jt1.jar_name AS caller_jar_name,
        callee.class_name AS callee_class_name,
        callee.method_name AS callee_method_name,
        callee.method_desc AS callee_method_desc,
        callee.jar_id AS callee_jar_id,
        jt2.jar_name AS callee_jar_name,
        mc.op_code AS op_code,
        mc.edge_type AS edge_type,
        mc.edge_confidence AS edge_confidence,
        mc.edge_evidence AS edge_evidence
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt1 ON caller.jar_id = jt1.jid
        LEFT JOIN jar_table jt2 ON callee.jar_id = jt2.jid
        <where>
            <if test="callerClassName != null and callerClassName != ''">
                AND caller.class_name = #{callerClassName}
            </if>
            <if test="callerMethodName != null and callerMethodName != ''">
                AND caller.method_name = #{callerMethodName}
            </if>
            <if test="callerMethodDesc != null and callerMethodDesc != ''">
                AND caller.method_desc = #{callerMethodDesc}
            </if>
        </where>
        <if test="limit != null and limit > 0">
            LIMIT #{limit}
            <if test="offset != null and offset &gt;= 0">
                OFFSET #{offset}
            </if>
        </if>
    </select>
    <select id="selectAllCallEdges" resultMap="callEdgeMap">
        SELECT
        caller.class_name AS caller_class_name,
        caller.method_name AS caller_method_name,
        caller.method_desc AS caller_method_desc,
        caller.jar_id AS caller_jar_id,
        jt1.jar_name AS caller_jar_name,
        callee.class_name AS callee_class_name,
        callee.method_name AS callee_method_name,
        callee.method_desc AS callee_method_desc,
        callee.jar_id AS callee_jar_id,
        jt2.jar_name AS callee_jar_name,
        mc.op_code AS op_code,
        mc.edge_type AS edge_type,
        mc.edge_confidence AS edge_confidence,
        mc.edge_evidence AS edge_evidence
        FROM method_call_table mc
        INNER JOIN method_table caller ON mc.caller_mid = caller.method_id
        INNER JOIN method_table callee ON mc.callee_mid = callee.method_id
        LEFT JOIN jar_table jt1 ON caller.jar_id = jt1.jid
        LEFT JOIN jar_table jt2 ON callee.jar_id = jt2.jid
    </select>
</mapper>
