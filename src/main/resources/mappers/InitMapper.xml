<?xml version="1.0" encoding="UTF-8"?>
<!--
  ~ GPLv3 License
  ~
  ~ Copyright (c) 2022-2026 4ra1n (Jar Analyzer Team)
  ~
  ~ This project is distributed under the GPLv3 license.
  ~
  ~ https://github.com/jar-analyzer/jar-analyzer/blob/master/LICENSE
  -->

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="me.n1ar4.jar.analyzer.core.mapper.InitMapper">
    <update id="createJarTable">
        CREATE TABLE IF NOT EXISTS jar_table
        (
            jid INTEGER NOT NULL
            CONSTRAINT jar_table_pk PRIMARY KEY AUTOINCREMENT,
            jar_name TEXT NOT NULL,
            jar_abs_path TEXT NOT NULL
        );
    </update>
    <update id="createClassTable">
        CREATE TABLE IF NOT EXISTS class_table
        (
            cid INTEGER NOT NULL
            CONSTRAINT class_table_pk PRIMARY KEY AUTOINCREMENT,
            jar_id INTEGER NOT NULL,
            jar_name TEXT NOT NULL,
            version INTEGER NOT NULL,
            access INTEGER NOT NULL,
            class_name TEXT NOT NULL,
            super_class_name TEXT,
            is_interface INTEGER NOT NULL
        );
    </update>
    <update id="createClassFileTable">
        CREATE TABLE IF NOT EXISTS class_file_table
        (
            cf_id INTEGER NOT NULL
            CONSTRAINT class_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            path_str TEXT NOT NULL,
            jar_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createMemberTable">
        CREATE TABLE IF NOT EXISTS member_table
        (
            mid INTEGER NOT NULL
            CONSTRAINT member_table_pk PRIMARY KEY AUTOINCREMENT,
            member_name TEXT NOT NULL,
            modifiers INTEGER NOT NULL,
            value TEXT NOT NULL,
            method_desc TEXT NOT NULL,
            method_signature TEXT,
            type_class_name TEXT NOT NULL,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createMethodTable">
        CREATE TABLE IF NOT EXISTS method_table
        (
            method_id INTEGER NOT NULL
            CONSTRAINT method_table_pk PRIMARY KEY AUTOINCREMENT,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL,
            is_static INTEGER NOT NULL,
            class_name TEXT NOT NULL,
            access INTEGER NOT NULL,
            line_number INTEGER NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createAnnoTable">
        CREATE TABLE IF NOT EXISTS anno_table
        (
            anno_id INTEGER NOT NULL
            CONSTRAINT anno_table_pk PRIMARY KEY AUTOINCREMENT,
            anno_name TEXT NOT NULL,
            method_name TEXT,
            class_name TEXT,
            visible INTEGER NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createInterfaceTable">
        CREATE TABLE IF NOT EXISTS interface_table
        (
            iid INTEGER NOT NULL
            CONSTRAINT interface_table_pk PRIMARY KEY AUTOINCREMENT,
            interface_name TEXT NOT NULL,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createMethodCallTable">
        CREATE TABLE IF NOT EXISTS method_call_table
        (
            mc_id INTEGER NOT NULL
            CONSTRAINT method_call_table_pk PRIMARY KEY AUTOINCREMENT,
            caller_method_name TEXT NOT NULL,
            caller_class_name TEXT NOT NULL,
            caller_method_desc TEXT NOT NULL,
            caller_jar_id INTEGER NOT NULL,
            callee_method_name TEXT NOT NULL,
            callee_method_desc TEXT NOT NULL,
            callee_class_name TEXT NOT NULL,
            callee_jar_id INTEGER NOT NULL,
            op_code INTEGER NOT NULL,
            edge_type TEXT NOT NULL DEFAULT 'direct',
            edge_confidence TEXT NOT NULL DEFAULT 'high',
            edge_evidence TEXT NOT NULL DEFAULT '',
            call_site_key TEXT NOT NULL DEFAULT ''
        );
    </update>
    <update id="addMethodCallEdgeTypeColumn">
        ALTER TABLE method_call_table
        ADD COLUMN edge_type TEXT NOT NULL DEFAULT 'direct';
    </update>
    <update id="addMethodCallEdgeConfidenceColumn">
        ALTER TABLE method_call_table
        ADD COLUMN edge_confidence TEXT NOT NULL DEFAULT 'high';
    </update>
    <update id="addMethodCallEdgeEvidenceColumn">
        ALTER TABLE method_call_table
        ADD COLUMN edge_evidence TEXT NOT NULL DEFAULT '';
    </update>
    <update id="addMethodCallSiteKeyColumn">
        ALTER TABLE method_call_table
        ADD COLUMN call_site_key TEXT NOT NULL DEFAULT '';
    </update>
    <update id="createMethodCallIndex">
        CREATE INDEX IF NOT EXISTS idx_method_call_callee
        ON method_call_table(callee_class_name, callee_method_name, callee_method_desc);
        CREATE INDEX IF NOT EXISTS idx_method_call_caller
        ON method_call_table(caller_class_name, caller_method_name, caller_method_desc);
        CREATE INDEX IF NOT EXISTS idx_method_call_edge
        ON method_call_table(
            caller_class_name, caller_method_name, caller_method_desc,
            callee_class_name, callee_method_name, callee_method_desc
        );
        CREATE INDEX IF NOT EXISTS idx_method_call_site_key
        ON method_call_table(call_site_key);
    </update>
    <update id="createMethodImplTable">
        CREATE TABLE IF NOT EXISTS method_impl_table
        (
            impl_id INTEGER NOT NULL
            CONSTRAINT method_impl_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL,
            impl_class_name TEXT NOT NULL,
            class_jar_id INTEGER NOT NULL,
            impl_class_jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createStringTable">
        CREATE TABLE IF NOT EXISTS string_table
        (
            sid INTEGER NOT NULL
            CONSTRAINT string_table_pk PRIMARY KEY AUTOINCREMENT,
            value TEXT NOT NULL,
            access INTEGER NOT NULL,
            method_desc TEXT NOT NULL,
            method_name TEXT NOT NULL,
            class_name TEXT NOT NULL,
            jar_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createStringFtsTable">
        CREATE VIRTUAL TABLE IF NOT EXISTS string_fts USING fts5(
            value, class_name, method_name, method_desc, jar_id, jar_name,
            content='string_table', content_rowid='sid'
        );
    </update>
    <update id="createStringIndex">
        CREATE INDEX IF NOT EXISTS idx_string_value_nocase
        ON string_table(value COLLATE NOCASE);
    </update>
    <update id="createResourceTable">
        CREATE TABLE IF NOT EXISTS resource_table
        (
            rid INTEGER NOT NULL
            CONSTRAINT resource_table_pk PRIMARY KEY AUTOINCREMENT,
            resource_path TEXT NOT NULL,
            path_str TEXT NOT NULL,
            jar_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL,
            file_size INTEGER NOT NULL,
            is_text INTEGER NOT NULL
        );
    </update>
    <update id="createResourceIndex">
        CREATE INDEX IF NOT EXISTS idx_resource_path
        ON resource_table(resource_path);
        CREATE INDEX IF NOT EXISTS idx_resource_jar_path
        ON resource_table(jar_id, resource_path);
    </update>
    <update id="createSpringControllerTable">
        CREATE TABLE IF NOT EXISTS spring_controller_table
        (
            sc_id INTEGER
            CONSTRAINT spring_controller_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createSpringMappingTable">
        CREATE TABLE IF NOT EXISTS spring_method_table
        (
            sm_id INTEGER
            CONSTRAINT spring_method_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL,
            restful_type TEXT NOT NULL,
            path TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createSpringInterceptorTable">
        CREATE TABLE IF NOT EXISTS spring_interceptor_table
        (
            si_id INTEGER
            CONSTRAINT spring_interceptor_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createJavaWebTable">
        CREATE TABLE IF NOT EXISTS java_web_table
        (
            jw_id INTEGER
            CONSTRAINT java_web_table_pk PRIMARY KEY AUTOINCREMENT,
            type_name TEXT NOT NULL,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createDFSResultTable">
        CREATE TABLE IF NOT EXISTS dfs_result_table
        (
            dr_id INTEGER
            CONSTRAINT dfs_result_table_pk PRIMARY KEY AUTOINCREMENT,
            source_class_name TEXT NOT NULL,
            source_method_name TEXT NOT NULL,
            source_method_desc TEXT NOT NULL,
            sink_class_name TEXT NOT NULL,
            sink_method_name TEXT NOT NULL,
            sink_method_desc TEXT NOT NULL,
            dfs_depth INTEGER NOT NULL,
            dfs_mode INTEGER NOT NULL,
            dfs_list_uid TEXT NOT NULL
        );
    </update>
    <update id="createDFSResultListTable">
        CREATE TABLE IF NOT EXISTS dfs_result_list_table
        (
            drl_id INTEGER
            CONSTRAINT dfs_result_list_table_pk PRIMARY KEY AUTOINCREMENT,
            dfs_list_uid TEXT NOT NULL,
            dfs_list_index INTEGER NOT NULL,
            dfs_class_name TEXT NOT NULL,
            dfs_method_name TEXT NOT NULL,
            dfs_method_desc TEXT NOT NULL
        );
    </update>
    <update id="createFavoriteTable">
        CREATE TABLE IF NOT EXISTS note_favorite_table
        (
            nf_id INTEGER
            CONSTRAINT note_favorite_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL
        );
    </update>
    <update id="createHistoryTable">
        CREATE TABLE IF NOT EXISTS note_history_table
        (
            nh_id INTEGER
            CONSTRAINT note_history_table_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL
        );
    </update>
    <update id="createCallSiteTable">
        CREATE TABLE IF NOT EXISTS bytecode_call_site_table
        (
            cs_id INTEGER
            CONSTRAINT bytecode_call_site_pk PRIMARY KEY AUTOINCREMENT,
            caller_class_name TEXT NOT NULL,
            caller_method_name TEXT NOT NULL,
            caller_method_desc TEXT NOT NULL,
            callee_owner TEXT NOT NULL,
            callee_method_name TEXT NOT NULL,
            callee_method_desc TEXT NOT NULL,
            op_code INTEGER NOT NULL,
            line_number INTEGER NOT NULL DEFAULT -1,
            call_index INTEGER NOT NULL DEFAULT -1,
            receiver_type TEXT,
            jar_id INTEGER NOT NULL,
            call_site_key TEXT NOT NULL DEFAULT ''
        );
    </update>
    <update id="upgradeCallSiteTable">
        ALTER TABLE bytecode_call_site_table
            ADD COLUMN call_index INTEGER NOT NULL DEFAULT -1;
    </update>
    <update id="addCallSiteKeyColumn">
        ALTER TABLE bytecode_call_site_table
            ADD COLUMN call_site_key TEXT NOT NULL DEFAULT '';
    </update>
    <update id="createCallSiteIndex">
        CREATE INDEX IF NOT EXISTS idx_call_site_caller
        ON bytecode_call_site_table(caller_class_name, caller_method_name, caller_method_desc);
        CREATE INDEX IF NOT EXISTS idx_call_site_caller_idx
        ON bytecode_call_site_table(caller_class_name, caller_method_name, caller_method_desc, call_index);
        CREATE INDEX IF NOT EXISTS idx_call_site_callee
        ON bytecode_call_site_table(callee_owner, callee_method_name, callee_method_desc);
        CREATE INDEX IF NOT EXISTS idx_call_site_key
        ON bytecode_call_site_table(call_site_key);
    </update>
    <update id="createLocalVarTable">
        CREATE TABLE IF NOT EXISTS bytecode_local_var_table
        (
            lv_id INTEGER
            CONSTRAINT bytecode_local_var_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT NOT NULL,
            method_desc TEXT NOT NULL,
            var_index INTEGER NOT NULL,
            var_name TEXT,
            var_desc TEXT,
            var_signature TEXT,
            start_line INTEGER NOT NULL DEFAULT -1,
            end_line INTEGER NOT NULL DEFAULT -1,
            jar_id INTEGER NOT NULL
        );
    </update>
    <update id="createLocalVarIndex">
        CREATE INDEX IF NOT EXISTS idx_local_var_method
        ON bytecode_local_var_table(class_name, method_name, method_desc);
    </update>
    <update id="createLineMappingTable">
        CREATE TABLE IF NOT EXISTS line_mapping_table
        (
            lm_id INTEGER
            CONSTRAINT line_mapping_pk PRIMARY KEY AUTOINCREMENT,
            class_name TEXT NOT NULL,
            method_name TEXT,
            method_desc TEXT,
            jar_id INTEGER NOT NULL,
            decompiler TEXT NOT NULL,
            mapping_text TEXT NOT NULL
        );
    </update>
    <update id="createLineMappingIndex">
        CREATE INDEX IF NOT EXISTS idx_line_mapping_class
        ON line_mapping_table(class_name, jar_id, decompiler);
    </update>
    <update id="createSemanticCacheTable">
        CREATE TABLE IF NOT EXISTS semantic_cache_table
        (
            cache_key TEXT NOT NULL,
            cache_type TEXT NOT NULL,
            cache_value TEXT NOT NULL,
            update_time INTEGER NOT NULL DEFAULT (strftime('%s','now')),
            CONSTRAINT semantic_cache_pk PRIMARY KEY (cache_key, cache_type)
        );
    </update>
    <update id="createSemanticCacheIndex">
        CREATE INDEX IF NOT EXISTS idx_semantic_cache_type
        ON semantic_cache_table(cache_type);
    </update>

    <!-- unified project model (content/source/resource/library/sdk/generated/excluded) -->
    <update id="createProjectModelMetaTable">
        CREATE TABLE IF NOT EXISTS project_model_meta
        (
            build_seq INTEGER NOT NULL
            CONSTRAINT project_model_meta_pk PRIMARY KEY,
            build_mode TEXT NOT NULL DEFAULT 'artifact',
            project_name TEXT NOT NULL DEFAULT '',
            primary_input_path TEXT NOT NULL DEFAULT '',
            runtime_path TEXT NOT NULL DEFAULT '',
            resolve_inner_jars INTEGER NOT NULL DEFAULT 0,
            options_json TEXT NOT NULL DEFAULT '{}',
            created_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
        );
    </update>
    <update id="createProjectModelRootTable">
        CREATE TABLE IF NOT EXISTS project_model_root
        (
            root_id INTEGER NOT NULL
            CONSTRAINT project_model_root_pk PRIMARY KEY AUTOINCREMENT,
            build_seq INTEGER NOT NULL,
            root_kind TEXT NOT NULL,
            origin_kind TEXT NOT NULL,
            root_path TEXT NOT NULL,
            presentable_name TEXT NOT NULL DEFAULT '',
            is_archive INTEGER NOT NULL DEFAULT 0,
            is_test INTEGER NOT NULL DEFAULT 0,
            priority INTEGER NOT NULL DEFAULT 0,
            options_json TEXT NOT NULL DEFAULT '{}',
            CONSTRAINT project_model_root_uk UNIQUE (build_seq, root_kind, root_path)
        );
    </update>
    <update id="createProjectModelEntryTable">
        CREATE TABLE IF NOT EXISTS project_model_entry
        (
            entry_id INTEGER NOT NULL
            CONSTRAINT project_model_entry_pk PRIMARY KEY AUTOINCREMENT,
            build_seq INTEGER NOT NULL,
            root_id INTEGER NOT NULL DEFAULT -1,
            entry_kind TEXT NOT NULL,
            origin_kind TEXT NOT NULL,
            entry_path TEXT NOT NULL DEFAULT '',
            class_name TEXT NOT NULL DEFAULT '',
            resource_path TEXT NOT NULL DEFAULT '',
            jar_id INTEGER NOT NULL DEFAULT -1,
            jar_name TEXT NOT NULL DEFAULT '',
            options_json TEXT NOT NULL DEFAULT '{}'
        );
    </update>
    <update id="createProjectClassOriginTable">
        CREATE TABLE IF NOT EXISTS project_class_origin
        (
            build_seq INTEGER NOT NULL,
            class_name TEXT NOT NULL,
            jar_id INTEGER NOT NULL DEFAULT -1,
            origin_kind TEXT NOT NULL,
            root_kind TEXT NOT NULL,
            root_path TEXT NOT NULL DEFAULT '',
            CONSTRAINT project_class_origin_pk PRIMARY KEY (build_seq, class_name, jar_id)
        );
    </update>
    <update id="createProjectResourceOriginTable">
        CREATE TABLE IF NOT EXISTS project_resource_origin
        (
            build_seq INTEGER NOT NULL,
            resource_path TEXT NOT NULL,
            jar_id INTEGER NOT NULL DEFAULT -1,
            origin_kind TEXT NOT NULL,
            root_kind TEXT NOT NULL,
            root_path TEXT NOT NULL DEFAULT '',
            CONSTRAINT project_resource_origin_pk PRIMARY KEY (build_seq, resource_path, jar_id)
        );
    </update>
    <update id="createProjectModelIndex">
        CREATE INDEX IF NOT EXISTS idx_project_model_mode
        ON project_model_meta(build_mode, build_seq);
        CREATE INDEX IF NOT EXISTS idx_project_root_build_kind
        ON project_model_root(build_seq, root_kind, origin_kind);
        CREATE INDEX IF NOT EXISTS idx_project_root_origin_path
        ON project_model_root(origin_kind, root_path);
        CREATE INDEX IF NOT EXISTS idx_project_entry_build_kind
        ON project_model_entry(build_seq, entry_kind, origin_kind);
        CREATE INDEX IF NOT EXISTS idx_project_entry_origin_path
        ON project_model_entry(origin_kind, entry_path);
        CREATE INDEX IF NOT EXISTS idx_project_entry_class
        ON project_model_entry(class_name, jar_id, origin_kind);
        CREATE INDEX IF NOT EXISTS idx_project_class_origin_lookup
        ON project_class_origin(origin_kind, class_name, jar_id);
        CREATE INDEX IF NOT EXISTS idx_project_resource_origin_lookup
        ON project_resource_origin(origin_kind, resource_path, jar_id);
    </update>

    <update id="createGraphMetaTable">
        CREATE TABLE IF NOT EXISTS graph_meta
        (
            schema_version TEXT NOT NULL,
            build_seq INTEGER NOT NULL,
            built_at INTEGER NOT NULL DEFAULT (strftime('%s','now')),
            options_json TEXT NOT NULL DEFAULT '{}',
            CONSTRAINT graph_meta_pk PRIMARY KEY (schema_version, build_seq)
        );
    </update>
    <update id="createGraphNodeTable">
        CREATE TABLE IF NOT EXISTS graph_node
        (
            node_id INTEGER NOT NULL
            CONSTRAINT graph_node_pk PRIMARY KEY,
            kind TEXT NOT NULL,
            jar_id INTEGER NOT NULL DEFAULT -1,
            class_name TEXT NOT NULL DEFAULT '',
            method_name TEXT NOT NULL DEFAULT '',
            method_desc TEXT NOT NULL DEFAULT '',
            call_site_key TEXT NOT NULL DEFAULT '',
            line_number INTEGER NOT NULL DEFAULT -1,
            call_index INTEGER NOT NULL DEFAULT -1,
            props_json TEXT NOT NULL DEFAULT '{}',
            last_seen_build_seq INTEGER NOT NULL DEFAULT -1
        );
    </update>
    <update id="createGraphEdgeTable">
        CREATE TABLE IF NOT EXISTS graph_edge
        (
            edge_id INTEGER NOT NULL
            CONSTRAINT graph_edge_pk PRIMARY KEY,
            src_id INTEGER NOT NULL,
            dst_id INTEGER NOT NULL,
            rel_type TEXT NOT NULL,
            confidence TEXT NOT NULL DEFAULT 'low',
            evidence TEXT NOT NULL DEFAULT '',
            op_code INTEGER NOT NULL DEFAULT -1,
            weight REAL NOT NULL DEFAULT 1.0,
            props_json TEXT NOT NULL DEFAULT '{}',
            last_seen_build_seq INTEGER NOT NULL DEFAULT -1
        );
    </update>
    <update id="addGraphNodeLastSeenBuildSeqColumn">
        ALTER TABLE graph_node
            ADD COLUMN last_seen_build_seq INTEGER NOT NULL DEFAULT -1;
    </update>
    <update id="addGraphEdgeLastSeenBuildSeqColumn">
        ALTER TABLE graph_edge
            ADD COLUMN last_seen_build_seq INTEGER NOT NULL DEFAULT -1;
    </update>
    <update id="createGraphLabelTable">
        CREATE TABLE IF NOT EXISTS graph_label
        (
            node_id INTEGER NOT NULL,
            label TEXT NOT NULL,
            CONSTRAINT graph_label_pk PRIMARY KEY (node_id, label)
        );
    </update>
    <update id="createGraphAttrTable">
        CREATE TABLE IF NOT EXISTS graph_attr
        (
            owner_type TEXT NOT NULL,
            owner_id INTEGER NOT NULL,
            k TEXT NOT NULL,
            v_text TEXT,
            v_num REAL,
            v_bool INTEGER,
            CONSTRAINT graph_attr_pk PRIMARY KEY (owner_type, owner_id, k)
        );
    </update>
    <update id="createGraphStatsTable">
        CREATE TABLE IF NOT EXISTS graph_stats
        (
            metric TEXT NOT NULL
            CONSTRAINT graph_stats_pk PRIMARY KEY,
            metric_value TEXT NOT NULL,
            updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
        );
    </update>
    <update id="createGraphIndex">
        CREATE INDEX IF NOT EXISTS idx_graph_node_kind_sig
        ON graph_node(kind, class_name, method_name, method_desc, jar_id);
        CREATE INDEX IF NOT EXISTS idx_graph_node_callsite
        ON graph_node(call_site_key, class_name, method_name, method_desc, jar_id);
        CREATE INDEX IF NOT EXISTS idx_graph_edge_src_rel_dst
        ON graph_edge(src_id, rel_type, dst_id);
        CREATE INDEX IF NOT EXISTS idx_graph_edge_dst_rel_src
        ON graph_edge(dst_id, rel_type, src_id);
        CREATE INDEX IF NOT EXISTS idx_graph_edge_semantic
        ON graph_edge(src_id, dst_id, rel_type, confidence, evidence, op_code);
        CREATE INDEX IF NOT EXISTS idx_graph_node_last_seen
        ON graph_node(last_seen_build_seq, node_id);
        CREATE INDEX IF NOT EXISTS idx_graph_edge_last_seen
        ON graph_edge(last_seen_build_seq, edge_id);
        CREATE INDEX IF NOT EXISTS idx_graph_label_label
        ON graph_label(label, node_id);
        CREATE INDEX IF NOT EXISTS idx_graph_attr_lookup
        ON graph_attr(owner_type, k, v_text, v_num, v_bool, owner_id);
    </update>

    <update id="createCypherScriptTable">
        CREATE TABLE IF NOT EXISTS cypher_script_table
        (
            script_id INTEGER NOT NULL
            CONSTRAINT cypher_script_table_pk PRIMARY KEY AUTOINCREMENT,
            title TEXT NOT NULL,
            body TEXT NOT NULL,
            tags TEXT NOT NULL DEFAULT '',
            pinned INTEGER NOT NULL DEFAULT 0,
            created_at INTEGER NOT NULL DEFAULT (strftime('%s','now')),
            updated_at INTEGER NOT NULL DEFAULT (strftime('%s','now'))
        );
    </update>
    <update id="createCypherScriptIndex">
        CREATE INDEX IF NOT EXISTS idx_cypher_script_pin_update
        ON cypher_script_table(pinned, updated_at, script_id);
    </update>

    <!-- report MCP (embedded sqlite store) -->
    <update id="createVulReportTable">
        CREATE TABLE IF NOT EXISTS vul_report_table
        (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            type TEXT NOT NULL,
            reason TEXT NOT NULL,
            score INTEGER NOT NULL,
            trace TEXT NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        );
    </update>
</mapper>
