/*
 * GPLv3 License
 *
 * Copyright (c) 2022-2026 4ra1n (Jar Analyzer Team)
 *
 * This project is distributed under the GPLv3 license.
 *
 * https://github.com/jar-analyzer/jar-analyzer/blob/master/LICENSE
 */

package me.n1ar4.jar.analyzer.semantic;

import com.github.javaparser.Position;
import com.github.javaparser.Range;
import com.github.javaparser.ast.Node;
import com.github.javaparser.ast.body.ConstructorDeclaration;
import com.github.javaparser.ast.body.InitializerDeclaration;
import com.github.javaparser.ast.body.MethodDeclaration;
import com.github.javaparser.ast.body.Parameter;
import com.github.javaparser.ast.body.VariableDeclarator;
import com.github.javaparser.ast.expr.AssignExpr;
import com.github.javaparser.ast.expr.BinaryExpr;
import com.github.javaparser.ast.expr.Expression;
import com.github.javaparser.ast.expr.InstanceOfExpr;
import com.github.javaparser.ast.expr.LambdaExpr;
import com.github.javaparser.ast.expr.NameExpr;
import com.github.javaparser.ast.expr.UnaryExpr;
import com.github.javaparser.ast.expr.VariableDeclarationExpr;
import com.github.javaparser.ast.nodeTypes.NodeWithBody;
import com.github.javaparser.ast.stmt.BlockStmt;
import com.github.javaparser.ast.stmt.BreakStmt;
import com.github.javaparser.ast.stmt.CatchClause;
import com.github.javaparser.ast.stmt.ContinueStmt;
import com.github.javaparser.ast.stmt.DoStmt;
import com.github.javaparser.ast.stmt.ExpressionStmt;
import com.github.javaparser.ast.stmt.ForEachStmt;
import com.github.javaparser.ast.stmt.ForStmt;
import com.github.javaparser.ast.stmt.IfStmt;
import com.github.javaparser.ast.stmt.LabeledStmt;
import com.github.javaparser.ast.stmt.ReturnStmt;
import com.github.javaparser.ast.stmt.Statement;
import com.github.javaparser.ast.stmt.SwitchEntry;
import com.github.javaparser.ast.stmt.SwitchStmt;
import com.github.javaparser.ast.stmt.ThrowStmt;
import com.github.javaparser.ast.stmt.TryStmt;
import com.github.javaparser.ast.stmt.WhileStmt;
import org.objectweb.asm.Type;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

final class FlowTypeAnalyzer {
    private static final int LOOP_FIXPOINT_LIMIT = 3;
    
    private final TypeSolver solver;
        private final HierarchyResolver hierarchy;
        
    FlowTypeAnalyzer(TypeSolver solver) {
            this.solver = solver;
                    this.hierarchy = solver == null || solver.getEngine() == null
                                    ? null
                                                    : new HierarchyResolver(solver.getEngine());
                                                        }
                                                        
    TypeRef resolveLocalType(com.github.javaparser.ast.CompilationUnit cu,
                                 String name,
                                                              Position usagePos,
                                                                                           Node context,
                                                                                                                        CallContext ctx) {
                                                                                                                                if (solver == null || name == null || name.trim().isEmpty()) {
                                                                                                                                            return null;
                                                                                                                                                    }
                                                                                                                                                            if (usagePos == null) {
                                                                                                                                                                        return null;
                                                                                                                                                                                }
                                                                                                                                                                                        Node scopeRoot = solver.findScopeRoot(context);
                                                                                                                                                                                                if (scopeRoot == null) {
                                                                                                                                                                                                            return null;
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                            FlowState start = new FlowState();
                                                                                                                                                                                                                                    start = seedParameters(cu, scopeRoot, start);
                                                                                                                                                                                                                                            FlowResult result = analyzeScope(cu, scopeRoot, start, usagePos, ctx);
                                                                                                                                                                                                                                                    if (result == null || !result.found || result.stateAtTarget == null) {
                                                                                                                                                                                                                                                                return null;
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                return result.stateAtTarget.get(name);
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                    
    private FlowState seedParameters(com.github.javaparser.ast.CompilationUnit cu,
                                         Node scopeRoot,
                                                                              FlowState state) {
                                                                                      if (scopeRoot instanceof MethodDeclaration) {
                                                                                                  MethodDeclaration decl = (MethodDeclaration) scopeRoot;
                                                                                                              return seedParametersFromList(cu, decl.getParameters(), state);
                                                                                                                      }
                                                                                                                              if (scopeRoot instanceof ConstructorDeclaration) {
                                                                                                                                          ConstructorDeclaration decl = (ConstructorDeclaration) scopeRoot;
                                                                                                                                                      return seedParametersFromList(cu, decl.getParameters(), state);
                                                                                                                                                              }
                                                                                                                                                                      if (scopeRoot instanceof LambdaExpr) {
                                                                                                                                                                                  LambdaExpr lambda = (LambdaExpr) scopeRoot;
                                                                                                                                                                                              return seedParametersFromList(cu, lambda.getParameters(), state);
                                                                                                                                                                                                      }
                                                                                                                                                                                                              return state;
                                                                                                                                                                                                                  }
                                                                                                                                                                                                                  
    private FlowState seedParametersFromList(com.github.javaparser.ast.CompilationUnit cu,
                                                 List<Parameter> params,
                                                                                              FlowState state) {
                                                                                                      if (params == null || params.isEmpty()) {
                                                                                                                  return state;
                                                                                                                          }
                                                                                                                                  FlowState cur = state.copy();
                                                                                                                                          for (Parameter param : params) {
                                                                                                                                                      if (param == null || param.getName() == null) {
                                                                                                                                                                      continue;
                                                                                                                                                                                  }
                                                                                                                                                                                              String name = param.getNameAsString();
                                                                                                                                                                                                          if (name == null || name.trim().isEmpty()) {
                                                                                                                                                                                                                          continue;
                                                                                                                                                                                                                                      }
                                                                                                                                                                                                                                                  TypeRef type = solver.resolveTypeFromAstType(cu, param.getType());
                                                                                                                                                                                                                                                              if (type != null) {
                                                                                                                                                                                                                                                                              cur.set(name, type);
                                                                                                                                                                                                                                                                                          }
                                                                                                                                                                                                                                                                                                  }
                                                                                                                                                                                                                                                                                                          return cur;
                                                                                                                                                                                                                                                                                                              }
                                                                                                                                                                                                                                                                                                              
    private FlowResult analyzeScope(com.github.javaparser.ast.CompilationUnit cu,
                                        Node scopeRoot,
                                                                            FlowState start,
                                                                                                                Position target,
                                                                                                                                                    CallContext ctx) {
                                                                                                                                                            if (scopeRoot instanceof MethodDeclaration) {
                                                                                                                                                                        MethodDeclaration decl = (MethodDeclaration) scopeRoot;
                                                                                                                                                                                    if (!decl.getBody().isPresent()) {
                                                                                                                                                                                                    return FlowResult.notFound(start);
                                                                                                                                                                                                                }
                                                                                                                                                                                                                            return analyzeStatement(cu, decl.getBody().get(), start, target, ctx);
                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                            if (scopeRoot instanceof ConstructorDeclaration) {
                                                                                                                                                                                                                                                        ConstructorDeclaration decl = (ConstructorDeclaration) scopeRoot;
                                                                                                                                                                                                                                                                    return analyzeStatement(cu, decl.getBody(), start, target, ctx);
                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                    if (scopeRoot instanceof InitializerDeclaration) {
                                                                                                                                                                                                                                                                                                InitializerDeclaration decl = (InitializerDeclaration) scopeRoot;
                                                                                                                                                                                                                                                                                                            return analyzeStatement(cu, decl.getBody(), start, target, ctx);
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                            if (scopeRoot instanceof LambdaExpr) {
                                                                                                                                                                                                                                                                                                                                        LambdaExpr lambda = (LambdaExpr) scopeRoot;
                                                                                                                                                                                                                                                                                                                                                    if (lambda.getBody() instanceof Statement) {
                                                                                                                                                                                                                                                                                                                                                                    return analyzeStatement(cu, (Statement) lambda.getBody(), start, target, ctx);
                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                            return FlowResult.notFound(start);
                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                            return FlowResult.notFound(start);
                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                
    private FlowResult analyzeStatement(com.github.javaparser.ast.CompilationUnit cu,
                                            Statement stmt,
                                                                                    FlowState in,
                                                                                                                            Position target,
                                                                                                                                                                    CallContext ctx) {
                                                                                                                                                                            if (stmt == null) {
                                                                                                                                                                                        return FlowResult.notFound(in);
                                                                                                                                                                                                }
                                                                                                                                                                                                        if (target != null && contains(stmt.getRange().orElse(null), target)
                                                                                                                                                                                                                        && stmt instanceof BlockStmt) {
                                                                                                                                                                                                                                    return analyzeBlock(cu, (BlockStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                    if (target != null && contains(stmt.getRange().orElse(null), target)) {
                                                                                                                                                                                                                                                                FlowResult inner = analyzeNested(cu, stmt, in, target, ctx);
                                                                                                                                                                                                                                                                            if (inner != null && inner.found) {
                                                                                                                                                                                                                                                                                            return inner;
                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                    return FlowResult.found(in);
                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                    FlowResult out = analyzeNested(cu, stmt, in, null, ctx);
                                                                                                                                                                                                                                                                                                                                            if (out == null) {
                                                                                                                                                                                                                                                                                                                                                        return FlowResult.notFound(in);
                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                        return out;
                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                            
    private FlowResult analyzeBlock(com.github.javaparser.ast.CompilationUnit cu,
                                        BlockStmt block,
                                                                            FlowState in,
                                                                                                                Position target,
                                                                                                                                                    CallContext ctx) {
                                                                                                                                                            FlowState cur = in.copy();
                                                                                                                                                                    for (Statement stmt : block.getStatements()) {
                                                                                                                                                                                FlowResult res = analyzeStatement(cu, stmt, cur, target, ctx);
                                                                                                                                                                                            if (res.found) {
                                                                                                                                                                                                            return res;
                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                    if (res.terminated) {
                                                                                                                                                                                                                                                    return FlowResult.notFound(cur, true);
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                            cur = res.outState == null ? cur : res.outState;
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                            return FlowResult.notFound(cur);
                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                
    private FlowResult analyzeNested(com.github.javaparser.ast.CompilationUnit cu,
                                         Statement stmt,
                                                                              FlowState in,
                                                                                                                   Position target,
                                                                                                                                                        CallContext ctx) {
                                                                                                                                                                if (stmt instanceof BlockStmt) {
                                                                                                                                                                            return analyzeBlock(cu, (BlockStmt) stmt, in, target, ctx);
                                                                                                                                                                                    }
                                                                                                                                                                                            if (stmt instanceof IfStmt) {
                                                                                                                                                                                                        return analyzeIf(cu, (IfStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                }
                                                                                                                                                                                                                        if (stmt instanceof ForStmt) {
                                                                                                                                                                                                                                    return analyzeFor(cu, (ForStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                    if (stmt instanceof ForEachStmt) {
                                                                                                                                                                                                                                                                return analyzeForEach(cu, (ForEachStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                if (stmt instanceof WhileStmt) {
                                                                                                                                                                                                                                                                                            return analyzeLoop(cu, (WhileStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                            if (stmt instanceof DoStmt) {
                                                                                                                                                                                                                                                                                                                        return analyzeDoLoop(cu, (DoStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                        if (stmt instanceof SwitchStmt) {
                                                                                                                                                                                                                                                                                                                                                    return analyzeSwitch(cu, (SwitchStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                    if (stmt instanceof TryStmt) {
                                                                                                                                                                                                                                                                                                                                                                                return analyzeTry(cu, (TryStmt) stmt, in, target, ctx);
                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                if (stmt instanceof LabeledStmt) {
                                                                                                                                                                                                                                                                                                                                                                                                            return analyzeStatement(cu, ((LabeledStmt) stmt).getStatement(), in, target, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                            if (stmt instanceof ReturnStmt || stmt instanceof ThrowStmt) {
                                                                                                                                                                                                                                                                                                                                                                                                                                        FlowState cur = applyStatementEffects(cu, stmt, in, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                    return FlowResult.notFound(cur, true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                    if (stmt instanceof BreakStmt || stmt instanceof ContinueStmt) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return FlowResult.notFound(in, true);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                FlowState out = applyStatementEffects(cu, stmt, in, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return FlowResult.notFound(out);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
    private FlowResult analyzeIf(com.github.javaparser.ast.CompilationUnit cu,
                                     IfStmt ifs,
                                                                      FlowState in,
                                                                                                       Position target,
                                                                                                                                        CallContext ctx) {
                                                                                                                                                Expression condition = ifs.getCondition();
                                                                                                                                                        Node thenStmt = ifs.getThenStmt();
                                                                                                                                                                Node elseStmt = ifs.getElseStmt().orElse(null);
                                                                                                                                                                        if (target != null) {
                                                                                                                                                                                    if (contains(thenStmt.getRange().orElse(null), target)) {
                                                                                                                                                                                                    FlowState thenIn = applyConditionConstraints(cu, in, condition, true);
                                                                                                                                                                                                                    return analyzeStatement(cu, (Statement) thenStmt, thenIn, target, ctx);
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                            if (elseStmt != null && contains(elseStmt.getRange().orElse(null), target)) {
                                                                                                                                                                                                                                                            FlowState elseIn = applyConditionConstraints(cu, in, condition, false);
                                                                                                                                                                                                                                                                            return analyzeStatement(cu, (Statement) elseStmt, elseIn, target, ctx);
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                    return FlowResult.found(in);
                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                    FlowState thenIn = applyConditionConstraints(cu, in, condition, true);
                                                                                                                                                                                                                                                                                                                            FlowResult thenRes = analyzeStatement(cu, (Statement) thenStmt, thenIn, null, ctx);
                                                                                                                                                                                                                                                                                                                                    FlowState elseIn = applyConditionConstraints(cu, in, condition, false);
                                                                                                                                                                                                                                                                                                                                            FlowResult elseRes = elseStmt == null
                                                                                                                                                                                                                                                                                                                                                            ? FlowResult.notFound(elseIn)
                                                                                                                                                                                                                                                                                                                                                                            : analyzeStatement(cu, (Statement) elseStmt, elseIn, null, ctx);
                                                                                                                                                                                                                                                                                                                                                                                    return mergeBranches(thenRes, elseRes);
                                                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                                        
    private FlowResult analyzeFor(com.github.javaparser.ast.CompilationUnit cu,
                                      ForStmt stmt,
                                                                        FlowState in,
                                                                                                          Position target,
                                                                                                                                            CallContext ctx) {
                                                                                                                                                    FlowState cur = in.copy();
                                                                                                                                                            for (Expression init : stmt.getInitialization()) {
                                                                                                                                                                        cur = applyExpressionEffects(cu, init, cur, ctx);
                                                                                                                                                                                }
                                                                                                                                                                                        if (target != null && contains(stmt.getRange().orElse(null), target)) {
                                                                                                                                                                                                    return analyzeLoopBody(cu, stmt, cur, target, ctx);
                                                                                                                                                                                                            }
                                                                                                                                                                                                                    FlowState loopOut = analyzeLoopEffects(cu, stmt, cur, ctx);
                                                                                                                                                                                                                            for (Expression update : stmt.getUpdate()) {
                                                                                                                                                                                                                                        loopOut = applyExpressionEffects(cu, update, loopOut, ctx);
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                        return FlowResult.notFound(loopOut);
                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                            
    private FlowResult analyzeForEach(com.github.javaparser.ast.CompilationUnit cu,
                                          ForEachStmt stmt,
                                                                                FlowState in,
                                                                                                                      Position target,
                                                                                                                                                            CallContext ctx) {
                                                                                                                                                                    FlowState cur = in.copy();
                                                                                                                                                                            VariableDeclarationExpr var = stmt.getVariable();
                                                                                                                                                                                    if (var != null) {
                                                                                                                                                                                                for (VariableDeclarator decl : var.getVariables()) {
                                                                                                                                                                                                                TypeRef type = solver.resolveTypeFromAstType(cu, decl.getType());
                                                                                                                                                                                                                                if (type != null && decl.getName() != null) {
                                                                                                                                                                                                                                                    cur.set(decl.getNameAsString(), type);
                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                if (target != null && contains(stmt.getRange().orElse(null), target)) {
                                                                                                                                                                                                                                                                                                            return analyzeLoopBody(cu, stmt, cur, target, ctx);
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                            FlowState loopOut = analyzeLoopEffects(cu, stmt, cur, ctx);
                                                                                                                                                                                                                                                                                                                                    return FlowResult.notFound(loopOut);
                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                        
    private FlowResult analyzeLoop(com.github.javaparser.ast.CompilationUnit cu,
                                       NodeWithBody<?> stmt,
                                                                          FlowState in,
                                                                                                             Position target,
                                                                                                                                                CallContext ctx) {
                                                                                                                                                        FlowState cur = in.copy();
                                                                                                                                                                if (target != null && contains(stmt.getBody().getRange().orElse(null), target)) {
                                                                                                                                                                            FlowState thenIn = applyConditionConstraints(cu, cur, extractCondition(stmt), true);
                                                                                                                                                                                        return analyzeStatement(cu, stmt.getBody(), thenIn, target, ctx);
                                                                                                                                                                                                }
                                                                                                                                                                                                        FlowState loopOut = analyzeLoopEffects(cu, stmt, cur, ctx);
                                                                                                                                                                                                                return FlowResult.notFound(loopOut);
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                    
    private FlowResult analyzeDoLoop(com.github.javaparser.ast.CompilationUnit cu,
                                         DoStmt stmt,
                                                                              FlowState in,
                                                                                                                   Position target,
                                                                                                                                                        CallContext ctx) {
                                                                                                                                                                FlowState cur = in.copy();
                                                                                                                                                                        if (target != null && contains(stmt.getBody().getRange().orElse(null), target)) {
                                                                                                                                                                                    return analyzeStatement(cu, stmt.getBody(), cur, target, ctx);
                                                                                                                                                                                            }
                                                                                                                                                                                                    FlowState loopOut = analyzeLoopEffects(cu, stmt, cur, ctx);
                                                                                                                                                                                                            return FlowResult.notFound(loopOut);
                                                                                                                                                                                                                }
                                                                                                                                                                                                                
    private FlowResult analyzeLoopBody(com.github.javaparser.ast.CompilationUnit cu,
                                           NodeWithBody<?> stmt,
                                                                                  FlowState in,
                                                                                                                         Position target,
                                                                                                                                                                CallContext ctx) {
                                                                                                                                                                        FlowState thenIn = applyConditionConstraints(cu, in, extractCondition(stmt), true);
                                                                                                                                                                                return analyzeStatement(cu, stmt.getBody(), thenIn, target, ctx);
                                                                                                                                                                                    }
                                                                                                                                                                                    
    private FlowState analyzeLoopEffects(com.github.javaparser.ast.CompilationUnit cu,
                                             NodeWithBody<?> stmt,
                                                                                      FlowState in,
                                                                                                                               CallContext ctx) {
                                                                                                                                       FlowState entry = in.copy();
                                                                                                                                               FlowState cur = entry;
                                                                                                                                                       for (int i = 0; i < LOOP_FIXPOINT_LIMIT; i++) {
                                                                                                                                                                   FlowState iterIn = applyConditionConstraints(cu, cur, extractCondition(stmt), true);
                                                                                                                                                                               FlowResult bodyRes = analyzeStatement(cu, stmt.getBody(), iterIn, null, ctx);
                                                                                                                                                                                           FlowState bodyOut = bodyRes.terminated ? null : bodyRes.outState;
                                                                                                                                                                                                       FlowState updated = mergeStates(entry, bodyOut);
                                                                                                                                                                                                                   if (updated.equals(cur)) {
                                                                                                                                                                                                                                   cur = updated;
                                                                                                                                                                                                                                                   break;
                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                           cur = updated;
                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                           return cur;
                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                               
    private FlowResult analyzeSwitch(com.github.javaparser.ast.CompilationUnit cu,
                                         SwitchStmt stmt,
                                                                              FlowState in,
                                                                                                                   Position target,
                                                                                                                                                        CallContext ctx) {
                                                                                                                                                                FlowState cur = in.copy();
                                                                                                                                                                        List<FlowResult> results = new ArrayList<>();
                                                                                                                                                                                for (SwitchEntry entry : stmt.getEntries()) {
                                                                                                                                                                                            if (target != null && contains(entry.getRange().orElse(null), target)) {
                                                                                                                                                                                                            FlowResult res = analyzeSwitchEntry(cu, entry, cur, target, ctx);
                                                                                                                                                                                                                            if (res != null && res.found) {
                                                                                                                                                                                                                                                return res;
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                return FlowResult.found(cur);
                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                        FlowResult entryRes = analyzeSwitchEntry(cu, entry, cur, null, ctx);
                                                                                                                                                                                                                                                                                                                    if (entryRes != null) {
                                                                                                                                                                                                                                                                                                                                    results.add(entryRes);
                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                return mergeMany(results, cur);
                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                    
    private FlowResult analyzeSwitchEntry(com.github.javaparser.ast.CompilationUnit cu,
                                              SwitchEntry entry,
                                                                                        FlowState in,
                                                                                                                                  Position target,
                                                                                                                                                                            CallContext ctx) {
                                                                                                                                                                                    FlowState cur = in.copy();
                                                                                                                                                                                            for (Statement stmt : entry.getStatements()) {
                                                                                                                                                                                                        FlowResult res = analyzeStatement(cu, stmt, cur, target, ctx);
                                                                                                                                                                                                                    if (res.found) {
                                                                                                                                                                                                                                    return res;
                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                            if (res.terminated) {
                                                                                                                                                                                                                                                                            return FlowResult.notFound(cur, true);
                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                    cur = res.outState == null ? cur : res.outState;
                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                    return FlowResult.notFound(cur);
                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                        
    private FlowResult analyzeTry(com.github.javaparser.ast.CompilationUnit cu,
                                      TryStmt stmt,
                                                                        FlowState in,
                                                                                                          Position target,
                                                                                                                                            CallContext ctx) {
                                                                                                                                                    if (target != null && contains(stmt.getRange().orElse(null), target)) {
                                                                                                                                                                if (contains(stmt.getTryBlock().getRange().orElse(null), target)) {
                                                                                                                                                                                return analyzeStatement(cu, stmt.getTryBlock(), in, target, ctx);
                                                                                                                                                                                            }
                                                                                                                                                                                                        for (CatchClause clause : stmt.getCatchClauses()) {
                                                                                                                                                                                                                        if (contains(clause.getRange().orElse(null), target)) {
                                                                                                                                                                                                                                            FlowState catchIn = seedCatchParameter(cu, clause, in);
                                                                                                                                                                                                                                                                return analyzeStatement(cu, clause.getBody(), catchIn, target, ctx);
                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                        if (stmt.getFinallyBlock().isPresent()
                                                                                                                                                                                                                                                                                                                            && contains(stmt.getFinallyBlock().get().getRange().orElse(null), target)) {
                                                                                                                                                                                                                                                                                                                                            return analyzeStatement(cu, stmt.getFinallyBlock().get(), in, target, ctx);
                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                    return FlowResult.found(in);
                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                    FlowResult tryRes = analyzeStatement(cu, stmt.getTryBlock(), in, null, ctx);
                                                                                                                                                                                                                                                                                                                                                                                            List<FlowResult> results = new ArrayList<>();
                                                                                                                                                                                                                                                                                                                                                                                                    results.add(tryRes);
                                                                                                                                                                                                                                                                                                                                                                                                            for (CatchClause clause : stmt.getCatchClauses()) {
                                                                                                                                                                                                                                                                                                                                                                                                                        FlowState catchIn = seedCatchParameter(cu, clause, in);
                                                                                                                                                                                                                                                                                                                                                                                                                                    results.add(analyzeStatement(cu, clause.getBody(), catchIn, null, ctx));
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                    FlowResult merged = mergeMany(results, in);
                                                                                                                                                                                                                                                                                                                                                                                                                                                            if (stmt.getFinallyBlock().isPresent() && !merged.terminated) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        FlowResult finallyRes = analyzeStatement(
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            cu, stmt.getFinallyBlock().get(), merged.outState == null ? in : merged.outState, null, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return FlowResult.notFound(finallyRes.outState, finallyRes.terminated);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        return merged;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
    private FlowState seedCatchParameter(com.github.javaparser.ast.CompilationUnit cu,
                                             CatchClause clause,
                                                                                      FlowState in) {
                                                                                              FlowState cur = in.copy();
                                                                                                      if (clause == null || clause.getParameter() == null) {
                                                                                                                  return cur;
                                                                                                                          }
                                                                                                                                  String name = clause.getParameter().getNameAsString();
                                                                                                                                          if (name == null || name.trim().isEmpty()) {
                                                                                                                                                      return cur;
                                                                                                                                                              }
                                                                                                                                                                      TypeRef type = solver.resolveTypeFromAstType(cu, clause.getParameter().getType());
                                                                                                                                                                              if (type != null) {
                                                                                                                                                                                          cur.set(name, type);
                                                                                                                                                                                                  }
                                                                                                                                                                                                          return cur;
                                                                                                                                                                                                              }
                                                                                                                                                                                                              
    private FlowState applyStatementEffects(com.github.javaparser.ast.CompilationUnit cu,
                                                Statement stmt,
                                                                                            FlowState in,
                                                                                                                                        CallContext ctx) {
                                                                                                                                                if (stmt instanceof ExpressionStmt) {
                                                                                                                                                            return applyExpressionEffects(cu, ((ExpressionStmt) stmt).getExpression(), in, ctx);
                                                                                                                                                                    }
                                                                                                                                                                            if (stmt instanceof ReturnStmt) {
                                                                                                                                                                                        ReturnStmt ret = (ReturnStmt) stmt;
                                                                                                                                                                                                    if (ret.getExpression().isPresent()) {
                                                                                                                                                                                                                    return applyExpressionEffects(cu, ret.getExpression().get(), in, ctx);
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                if (stmt instanceof ThrowStmt) {
                                                                                                                                                                                                                                                            ThrowStmt thr = (ThrowStmt) stmt;
                                                                                                                                                                                                                                                                        return applyExpressionEffects(cu, thr.getExpression(), in, ctx);
                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                        if (stmt instanceof ForStmt) {
                                                                                                                                                                                                                                                                                                    FlowState cur = in.copy();
                                                                                                                                                                                                                                                                                                                ForStmt fs = (ForStmt) stmt;
                                                                                                                                                                                                                                                                                                                            for (Expression init : fs.getInitialization()) {
                                                                                                                                                                                                                                                                                                                                            cur = applyExpressionEffects(cu, init, cur, ctx);
                                                                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                                                                    for (Expression update : fs.getUpdate()) {
                                                                                                                                                                                                                                                                                                                                                                                    cur = applyExpressionEffects(cu, update, cur, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                            return cur;
                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                            return in;
                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                
    private FlowState applyExpressionEffects(com.github.javaparser.ast.CompilationUnit cu,
                                                 Expression expr,
                                                                                              FlowState in,
                                                                                                                                           CallContext ctx) {
                                                                                                                                                   if (expr == null) {
                                                                                                                                                               return in;
                                                                                                                                                                       }
                                                                                                                                                                               FlowState cur = in.copy();
                                                                                                                                                                                       if (expr instanceof AssignExpr) {
                                                                                                                                                                                                   AssignExpr assign = (AssignExpr) expr;
                                                                                                                                                                                                               Expression target = unwrapEnclosed(assign.getTarget());
                                                                                                                                                                                                                           if (target instanceof NameExpr) {
                                                                                                                                                                                                                                           String varName = ((NameExpr) target).getNameAsString();
                                                                                                                                                                                                                                                           Expression value = assign.getValue();
                                                                                                                                                                                                                                                                           if (!(value instanceof NameExpr && varName.equals(((NameExpr) value).getNameAsString()))) {
                                                                                                                                                                                                                                                                                               TypeRef type = solver.resolveExpressionType(cu, value, ctx);
                                                                                                                                                                                                                                                                                                                   if (type != null) {
                                                                                                                                                                                                                                                                                                                                           cur.set(varName, type);
                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                       return cur;
                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                       if (expr instanceof VariableDeclarationExpr) {
                                                                                                                                                                                                                                                                                                                                                                                                                                   VariableDeclarationExpr vde = (VariableDeclarationExpr) expr;
                                                                                                                                                                                                                                                                                                                                                                                                                                               for (VariableDeclarator var : vde.getVariables()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                               if (var == null || var.getName() == null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   String name = var.getNameAsString();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TypeRef declared = solver.resolveTypeFromAstType(cu, var.getType());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if (declared != null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       cur.set(name, declared);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           if (var.getInitializer().isPresent()) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               Expression init = var.getInitializer().get();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   if (init instanceof NameExpr && name.equals(((NameExpr) init).getNameAsString())) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           continue;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   TypeRef inferred = solver.resolveExpressionType(cu, init, ctx);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       if (inferred != null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               cur.set(name, inferred);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return cur;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           return cur;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
    private FlowState applyConditionConstraints(com.github.javaparser.ast.CompilationUnit cu,
                                                    FlowState in,
                                                                                                    Expression condition,
                                                                                                                                                    boolean positive) {
                                                                                                                                                            if (condition == null) {
                                                                                                                                                                        return in;
                                                                                                                                                                                }
                                                                                                                                                                                        Map<String, TypeRef> constraints = new HashMap<>();
                                                                                                                                                                                                collectInstanceofConstraints(cu, condition, positive, constraints);
                                                                                                                                                                                                        if (constraints.isEmpty()) {
                                                                                                                                                                                                                    return in;
                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                    FlowState cur = in.copy();
                                                                                                                                                                                                                                            for (Map.Entry<String, TypeRef> entry : constraints.entrySet()) {
                                                                                                                                                                                                                                                        if (entry.getKey() == null || entry.getValue() == null) {
                                                                                                                                                                                                                                                                        continue;
                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                cur.set(entry.getKey(), entry.getValue());
                                                                                                                                                                                                                                                                                                        }
                                                                                                                                                                                                                                                                                                                return cur;
                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                    
    private void collectInstanceofConstraints(com.github.javaparser.ast.CompilationUnit cu,
                                                   Expression condition,
                                                                                                  boolean positive,
                                                                                                                                                 Map<String, TypeRef> out) {
                                                                                                                                                         if (condition == null) {
                                                                                                                                                                     return;
                                                                                                                                                                             }
                                                                                                                                                                                     Expression expr = unwrapEnclosed(condition);
                                                                                                                                                                                             if (expr instanceof UnaryExpr) {
                                                                                                                                                                                                         UnaryExpr unary = (UnaryExpr) expr;
                                                                                                                                                                                                                     if (unary.getOperator() == UnaryExpr.Operator.LOGICAL_COMPLEMENT) {
                                                                                                                                                                                                                                     collectInstanceofConstraints(cu, unary.getExpression(), !positive, out);
                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                             return;
                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                             if (expr instanceof BinaryExpr) {
                                                                                                                                                                                                                                                                                         BinaryExpr binary = (BinaryExpr) expr;
                                                                                                                                                                                                                                                                                                     if (binary.getOperator() == BinaryExpr.Operator.AND && positive) {
                                                                                                                                                                                                                                                                                                                     collectInstanceofConstraints(cu, binary.getLeft(), true, out);
                                                                                                                                                                                                                                                                                                                                     collectInstanceofConstraints(cu, binary.getRight(), true, out);
                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                             return;
                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                             if (expr instanceof InstanceOfExpr) {
                                                                                                                                                                                                                                                                                                                                                                                         if (!positive) {
                                                                                                                                                                                                                                                                                                                                                                                                         return;
                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                 InstanceOfExpr inst = (InstanceOfExpr) expr;
                                                                                                                                                                                                                                                                                                                                                                                                                                             Expression left = unwrapEnclosed(inst.getExpression());
                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (!(left instanceof NameExpr)) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                         return;
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 String name = ((NameExpr) left).getNameAsString();
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             TypeRef type = solver.resolveTypeFromAstType(cu, inst.getType());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         if (name != null && type != null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         out.put(name, type);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
    private Expression unwrapEnclosed(Expression expr) {
            Expression cur = expr;
                    while (cur instanceof com.github.javaparser.ast.expr.EnclosedExpr) {
                                cur = ((com.github.javaparser.ast.expr.EnclosedExpr) cur).getInner();
                                        }
                                                return cur;
                                                    }
                                                    
    private Expression extractCondition(NodeWithBody<?> stmt) {
            if (stmt instanceof WhileStmt) {
                        return ((WhileStmt) stmt).getCondition();
                                }
                                        if (stmt instanceof ForStmt) {
                                                    return ((ForStmt) stmt).getCompare().orElse(null);
                                                            }
                                                                    if (stmt instanceof DoStmt) {
                                                                                return ((DoStmt) stmt).getCondition();
                                                                                        }
                                                                                                return null;
                                                                                                    }
                                                                                                    
    private FlowResult mergeBranches(FlowResult left, FlowResult right) {
            if (left.terminated && right.terminated) {
                        return FlowResult.notFound(null, true);
                                }
                                        if (left.terminated) {
                                                    return FlowResult.notFound(right.outState, right.terminated);
                                                            }
                                                                    if (right.terminated) {
                                                                                return FlowResult.notFound(left.outState, left.terminated);
                                                                                        }
                                                                                                FlowState merged = mergeStates(left.outState, right.outState);
                                                                                                        return FlowResult.notFound(merged);
                                                                                                            }
                                                                                                            
    private FlowResult mergeMany(List<FlowResult> results, FlowState fallback) {
            if (results == null || results.isEmpty()) {
                        return FlowResult.notFound(fallback);
                                }
                                        FlowState merged = null;
                                                boolean allTerminated = true;
                                                        for (FlowResult res : results) {
                                                                    if (res == null) {
                                                                                    continue;
                                                                                                }
                                                                                                            if (!res.terminated) {
                                                                                                                            allTerminated = false;
                                                                                                                                        }
                                                                                                                                                    merged = mergeStates(merged, res.outState);
                                                                                                                                                            }
                                                                                                                                                                    if (allTerminated) {
                                                                                                                                                                                return FlowResult.notFound(null, true);
                                                                                                                                                                                        }
                                                                                                                                                                                                if (merged == null) {
                                                                                                                                                                                                            merged = fallback;
                                                                                                                                                                                                                    }
                                                                                                                                                                                                                            return FlowResult.notFound(merged);
                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                
    private FlowState mergeStates(FlowState left, FlowState right) {
            if (left == null && right == null) {
                        return new FlowState();
                                }
                                        if (left == null) {
                                                    return right == null ? new FlowState() : right.copy();
                                                            }
                                                                    if (right == null) {
                                                                                return left.copy();
                                                                                        }
                                                                                                FlowState merged = new FlowState();
                                                                                                        merged.merge(left, this::mergeType);
                                                                                                                merged.merge(right, this::mergeType);
                                                                                                                        return merged;
                                                                                                                            }
                                                                                                                            
    private TypeRef mergeType(TypeRef left, TypeRef right) {
            if (left == null) {
                        return right;
                                }
                                        if (right == null) {
                                                    return left;
                                                            }
                                                                    Type l = left.getAsmType();
                                                                            Type r = right.getAsmType();
                                                                                    if (l == null || r == null) {
                                                                                                if (left.getInternalName() != null && left.getInternalName().equals(right.getInternalName())) {
                                                                                                                return left;
                                                                                                                            }
                                                                                                                                        return TypeRef.fromInternalName("java/lang/Object");
                                                                                                                                                }
                                                                                                                                                        if (left.isPrimitive() && right.isPrimitive()) {
                                                                                                                                                                    Type wider = widerPrimitiveType(l, r);
                                                                                                                                                                                return wider == null ? left : TypeRef.fromAsmType(wider);
                                                                                                                                                                                        }
                                                                                                                                                                                                if (left.isArray() && right.isArray()) {
                                                                                                                                                                                                            Type elemLeft = l.getElementType();
                                                                                                                                                                                                                        Type elemRight = r.getElementType();
                                                                                                                                                                                                                                    if (elemLeft != null && elemRight != null && elemLeft.equals(elemRight)) {
                                                                                                                                                                                                                                                    return left;
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                            if (elemLeft != null && elemRight != null
                                                                                                                                                                                                                                                                                                && elemLeft.getSort() == Type.OBJECT
                                                                                                                                                                                                                                                                                                                    && elemRight.getSort() == Type.OBJECT
                                                                                                                                                                                                                                                                                                                                        && hierarchy != null) {
                                                                                                                                                                                                                                                                                                                                                        String common = commonSuper(elemLeft.getInternalName(), elemRight.getInternalName());
                                                                                                                                                                                                                                                                                                                                                                        if (common != null) {
                                                                                                                                                                                                                                                                                                                                                                                            Type arrayType = Type.getType("[" + Type.getObjectType(common).getDescriptor());
                                                                                                                                                                                                                                                                                                                                                                                                                return TypeRef.fromAsmType(arrayType);
                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                        return TypeRef.fromInternalName("java/lang/Object");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                        if (l.getSort() == Type.OBJECT && r.getSort() == Type.OBJECT) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    String common = commonSuper(l.getInternalName(), r.getInternalName());
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                if (common != null) {
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                return TypeRef.fromInternalName(common);
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            return TypeRef.fromInternalName("java/lang/Object");
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
    private String commonSuper(String left, String right) {
            if (left == null || right == null) {
                        return "java/lang/Object";
                                }
                                        if (left.equals(right)) {
                                                    return left;
                                                            }
                                                                    if (hierarchy == null) {
                                                                                return "java/lang/Object";
                                                                                        }
                                                                                                if (hierarchy.isSubtype(left, right)) {
                                                                                                            return right;
                                                                                                                    }
                                                                                                                            if (hierarchy.isSubtype(right, left)) {
                                                                                                                                        return left;
                                                                                                                                                }
                                                                                                                                                        return "java/lang/Object";
                                                                                                                                                            }
                                                                                                                                                            
    private Type widerPrimitiveType(Type left, Type right) {
            if (left == null || right == null) {
                        return null;
                                }
                                        int rank = Math.max(primitiveRank(left.getSort()), primitiveRank(right.getSort()));
                                                switch (rank) {
                                                            case 6:
                                                                             return Type.DOUBLE_TYPE;
                                                                                         case 5:
                                                                                                          return Type.FLOAT_TYPE;
                                                                                                                      case 4:
                                                                                                                                       return Type.LONG_TYPE;
                                                                                                                                                   case 3:
                                                                                                                                                                    return Type.INT_TYPE;
                                                                                                                                                                                case 2:
                                                                                                                                                                                                 return Type.CHAR_TYPE;
                                                                                                                                                                                                             case 1:
                                                                                                                                                                                                                              return Type.SHORT_TYPE;
                                                                                                                                                                                                                                          case 0:
                                                                                                                                                                                                                                                           return Type.BYTE_TYPE;
                                                                                                                                                                                                                                                                       default:
                                                                                                                                                                                                                                                                                        return null;
                                                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                                                    }
                                                                                                                                                                                                                                                                                                    
    private int primitiveRank(int sort) {
            switch (sort) {
                        case Type.DOUBLE:
                                         return 6;
                                                     case Type.FLOAT:
                                                                      return 5;
                                                                                  case Type.LONG:
                                                                                                   return 4;
                                                                                                               case Type.INT:
                                                                                                                                return 3;
                                                                                                                                            case Type.CHAR:
                                                                                                                                                             return 2;
                                                                                                                                                                         case Type.SHORT:
                                                                                                                                                                                          return 1;
                                                                                                                                                                                                      case Type.BYTE:
                                                                                                                                                                                                                       return 0;
                                                                                                                                                                                                                                   default:
                                                                                                                                                                                                                                                    return -1;
                                                                                                                                                                                                                                                            }
                                                                                                                                                                                                                                                                }
                                                                                                                                                                                                                                                                
    private boolean contains(Range range, Position pos) {
            if (range == null || pos == null) {
                        return false;
                                }
                                        if (pos.line < range.begin.line || pos.line > range.end.line) {
                                                    return false;
                                                            }
                                                                    if (pos.line == range.begin.line && pos.column < range.begin.column) {
                                                                                return false;
                                                                                        }
                                                                                                if (pos.line == range.end.line && pos.column > range.end.column) {
                                                                                                            return false;
                                                                                                                    }
                                                                                                                            return true;
                                                                                                                                }
                                                                                                                                
    private static final class FlowState {
            private final Map<String, TypeRef> types;
            
        private FlowState() {
                    this.types = new HashMap<>();
                            }
                            
        private FlowState(Map<String, TypeRef> types) {
                    this.types = types;
                            }
                            
        private FlowState copy() {
                    return new FlowState(new HashMap<>(types));
                            }
                            
        private TypeRef get(String name) {
                    return types.get(name);
                            }
                            
        private void set(String name, TypeRef type) {
                    if (name == null || name.trim().isEmpty() || type == null) {
                                    return;
                                                }
                                                            types.put(name, type);
                                                                    }
                                                                    
        private void merge(FlowState other, TypeMerger merger) {
                    if (other == null) {
                                    return;
                                                }
                                                            for (Map.Entry<String, TypeRef> entry : other.types.entrySet()) {
                                                                            String name = entry.getKey();
                                                                                            TypeRef left = types.get(name);
                                                                                                            TypeRef right = entry.getValue();
                                                                                                                            TypeRef merged = merger.merge(left, right);
                                                                                                                                            types.put(name, merged);
                                                                                                                                                        }
                                                                                                                                                                }
                                                                                                                                                                
        @Override
                public boolean equals(Object obj) {
                            if (this == obj) {
                                            return true;
                                                        }
                                                                    if (!(obj instanceof FlowState)) {
                                                                                    return false;
                                                                                                }
                                                                                                            FlowState other = (FlowState) obj;
                                                                                                                        return types.equals(other.types);
                                                                                                                                }
                                                                                                                                    }
                                                                                                                                    
    private interface TypeMerger {
            TypeRef merge(TypeRef left, TypeRef right);
                }
                
    private static final class FlowResult {
            private final boolean found;
                    private final FlowState stateAtTarget;
                            private final FlowState outState;
                                    private final boolean terminated;
                                    
        private FlowResult(boolean found, FlowState stateAtTarget, FlowState outState, boolean terminated) {
                    this.found = found;
                                this.stateAtTarget = stateAtTarget;
                                            this.outState = outState;
                                                        this.terminated = terminated;
                                                                }
                                                                
        private static FlowResult found(FlowState state) {
                    return new FlowResult(true, state, state, false);
                            }
                            
        private static FlowResult notFound(FlowState outState) {
                    return new FlowResult(false, null, outState, false);
                            }
                            
        private static FlowResult notFound(FlowState outState, boolean terminated) {
                    return new FlowResult(false, null, outState, terminated);
                            }
                                }
                                }
                                
